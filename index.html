<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Codethug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Codethug">
<meta property="og:url" content="http://codethug.com/index.html">
<meta property="og:site_name" content="Codethug">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Codethug">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Open+Sans:400italic,400,600" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-61949305-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-61949305-1');
</script>
<!-- End Google Analytics -->


</head>
</html>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo">
        <!-- <i class="logo"></i> -->
        <span class="site-title">Codethug</span>
      </a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <div class="profile" id="profile-nav">
          <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://s.gravatar.com/avatar/e18193ec07249288118577b3b51c8834?s=128"><i class="fa fa-caret-down"></i></a>
        </div>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://codethug.com"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
        <td><a class="main-nav-link" href="/">Home</a></td>
      
        <td><a class="main-nav-link" href="/archives">Archives</a></td>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://codethug.com"></form>
      </td>
      </tr>
    </table>
  </div>
  
</header>

    <div class="outer">
      <aside id="profile">
  <div class="inner profile-inner">
  	<div class="base-info profile-block">
		  <img id="avatar" src="https://s.gravatar.com/avatar/e18193ec07249288118577b3b51c8834?s=128">
      <h2 id="name">Tim Larson</h2>
      <h3 id="title">Codethug</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Salt Lake City, UT</span>
      <!-- <a id="follow" href="null">FOLLOW</a> -->
  	</div>
    <!--<div class="article-info profile-block">
      <div class="article-info-block">
        59
        <span>posts</span>
      </div>
      <div class="article-info-block">
        0
        <span>tag</span>
      </div>
    </div>-->
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
        
          <td><a href="http://github.com/codethug" title="github"><i class="fa fa-github"></i></a></td>
        
          <td><a href="http://twitter.com/codethug" title="twitter"><i class="fa fa-twitter"></i></a></td>
        
          <td><a href="http://linkedin.com/in/larsontim" title="linkedin"><i class="fa fa-linkedin"></i></a></td>
        
          <td><a href="http://stackoverflow.com/users/133852/codethug" title="stack-overflow"><i class="fa fa-stack-overflow"></i></a></td>
        
          <td><a href="http://feeds.feedburner.com/CodeThug" title="rss"><i class="fa fa-rss"></i></a></td>
        
        </tr>
      </table>
    </div>
  </div>
</aside>

      <section id="main">
  
    <article id="post-Caching-with-Attributes-in-DotNet-Core5" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/17/Caching-with-Attributes-in-DotNet-Core5/">Caching with Attributes in .Net Core 5</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/2021/03/17/Caching-with-Attributes-in-DotNet-Core5/">
    <time datetime="2021-03-17T18:22:57.000Z" itemprop="datePublished">2021-03-17</time>
  </a>
</div>
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>You had a performance problem, and you solved it by implementing caching:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> people = PersonRepository.GetByLastName(personId);</span><br></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PersonRepository</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> secondsToCacheResult = <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;Person&gt;&gt; GetByLastName(<span class="keyword">string</span> lastName)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cacheKey = buildCacheKey(lastName);</span><br><span class="line">        <span class="keyword">if</span> (_cache.ContainsKey(cacheKey)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> _cache[cacheKey] <span class="keyword">as</span> Person;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This part takes a long time, that's why we </span></span><br><span class="line">        <span class="comment">// want to cache the results</span></span><br><span class="line">        <span class="keyword">var</span> people = SomeLongRunningProcess(lastName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> options = <span class="keyword">new</span> MemoryCacheEntryOptions</span><br><span class="line">        &#123;</span><br><span class="line">            AbsoluteExpirationRelativeToNow = <span class="keyword">new</span> System.TimeSpan(</span><br><span class="line">                hours: <span class="number">0</span>, minutes: <span class="number">0</span>, seconds: secondsToCacheResult)</span><br><span class="line">        &#125;;</span><br><span class="line">        _cache.Add(cacheKey, people, options)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> people;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And it worked!  The performance problem is solved.  But then you start caching things in several places in your repositories, and you end up with this exact same caching code everywhere.  Not only are you violating the <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="noopener">DRY principle</a>, but it makes it much harder to understand whatâ€™s really going on in the repository method.</p>
<p>This new problem can be solved by using Aspect Oriented Programming in a Dependency Injection framework by using interception with attributes to make your code look like this instead:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Cache(Seconds = 30)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;Person&gt;&gt; GetPeopleByLastName(<span class="keyword">string</span> lastName)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> SomeLongRunningProcess(lastName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We could use DI to <a href="https://www.palmmedia.de/Blog/2010/9/26/aop-interception-with-unity-20" target="_blank" rel="noopener">solve this with Microsoftâ€™s Unity DI</a>, or <a href="https://medium.com/@mohsen_rajabi/asp-core-automating-cache-with-aspect-programing-autofac-dynamic-proxy-8e6b84df44e4" target="_blank" rel="noopener">with AutoFac</a>.  Or we could <a href="https://doc.postsharp.net/caching-getting-started" target="_blank" rel="noopener">use PostSharp</a>, which â€˜weavesâ€™ the IL of your code with the code for caching at compile time.  But I wanted to get this working with Microsoftâ€™s DI framework that comes with .Net Core 5.</p>
<p>But thereâ€™s a problem - Microsoftâ€™s DI doesnâ€™t natively support interceptors, so we have to bring in some extra help.  In this case, weâ€™re going to use the Castle Projectâ€™s DynamicProxy library.  </p>
        
          <p class="article-more-link">
            <a href="/2021/03/17/Caching-with-Attributes-in-DotNet-Core5/">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codethug.com/2021/03/17/Caching-with-Attributes-in-DotNet-Core5/" data-id="ckmson8eu000m3gagfmhtjv57" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Mocking-Extension-Methods" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/09/Mocking-Extension-Methods/">Mocking Extension Methods</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/2017/09/09/Mocking-Extension-Methods/">
    <time datetime="2017-09-09T16:21:30.000Z" itemprop="datePublished">2017-09-09</time>
  </a>
</div>
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Mocking"><a href="#Mocking" class="headerlink" title="Mocking"></a>Mocking</h3><p>Mocking is a technique where a dependency to a class is swapped out (mocked) with an alternate/fake equivalent to the functionality so that the class can be tested in isolation from itâ€™s dependencies.  For these examples, Iâ€™ll be using the mocking framework <a href="https://github.com/moq/moq4" target="_blank" rel="noopener">Moq</a>.</p>
<p>Suppose we have a method that we wanted to mock:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPunctuation</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">string</span> <span class="title">AddExclamationPoint</span>(<span class="params"><span class="keyword">string</span> s</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Punctuation</span> : <span class="title">IPunctuation</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">AddExclamationPoint</span>(<span class="params"><span class="keyword">string</span> s</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> s + <span class="string">"!"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We use the method like this:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> punctuation = <span class="keyword">new</span> Punctuation();</span><br><span class="line"><span class="keyword">var</span> s = punctuation.AddExclamationPoint(<span class="string">"Hello"</span>);</span><br><span class="line"><span class="comment">// Result: "Hello!"</span></span><br></pre></td></tr></table></figure>
<p>Mocking this is fairly straighforward using Moq:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> punctuationMock = <span class="keyword">new</span> Mock&lt;IPunctuation&gt;();</span><br><span class="line">punctuationMock</span><br><span class="line">  .Setup(p =&gt; p.AddExclamationPoint(It.IsAny&lt;<span class="keyword">string</span>&gt;()))</span><br><span class="line">  .Returns(<span class="string">"HardcodedResult"</span>);</span><br><span class="line"><span class="keyword">var</span> punctuation = punctuationMock.Object;</span><br></pre></td></tr></table></figure>
<p>Once mocked, we use it in the exact same way as we use the real Punctuation class, but with the mocked result:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = punctuation.AddExclamationPoint(<span class="string">"Hello"</span>);</span><br><span class="line"><span class="comment">// Result: "HardcodedResult"</span></span><br></pre></td></tr></table></figure>
<p>Thatâ€™s mocking. For more on mocking, see <a href="https://github.com/Moq/moq4/wiki/Quickstart" target="_blank" rel="noopener">Moqâ€™s documentation</a>.</p>
<h3 id="Extension-Methods"><a href="#Extension-Methods" class="headerlink" title="Extension Methods"></a>Extension Methods</h3><p>Extension methods in C# are static methods that provide some helpful syntax to make code that consumes them a little more readable (and chainable).</p>
<p>We can change the method above to an extension method by making the class and method static and by adding the <code>this</code> keyword:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PunctuationExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">AddExclamationPoint</span>(<span class="params"><span class="keyword">this</span> <span class="keyword">string</span> s</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> s + <span class="string">"!"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And the usage of the extension method is a little cleaner:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">"Hello"</span>.AddExclamationPoint();</span><br><span class="line"><span class="comment">// Result: "Hello!";</span></span><br></pre></td></tr></table></figure>
<h3 id="Mocking-Extension-Methods"><a href="#Mocking-Extension-Methods" class="headerlink" title="Mocking Extension Methods"></a>Mocking Extension Methods</h3><p>I love to mock things when testing, and I love using extension methods, because I find both to be very helpful in writing clean, maintainable code.  But how can we mock an extension method?</p>
<p>In the example above, how would I mock out the <code>AddExclamationPoint()</code> method from the <code>PunctuationExtensions</code> class?</p>
<p>Well, you canâ€™t.</p>
        
          <p class="article-more-link">
            <a href="/2017/09/09/Mocking-Extension-Methods/">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codethug.com/2017/09/09/Mocking-Extension-Methods/" data-id="ckmson8er000i3gaguvpdoe46" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Chrome-58-and-Self-Signed-Certificates-in-IIS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/07/Chrome-58-and-Self-Signed-Certificates-in-IIS/">Chrome 58 and Self Signed Certificates in IIS</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/2017/09/07/Chrome-58-and-Self-Signed-Certificates-in-IIS/">
    <time datetime="2017-09-07T16:09:02.000Z" itemprop="datePublished">2017-09-07</time>
  </a>
</div>
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>When working in development, sometimes you need to use an SSL certificate.  There is no need to pay a provider to sign one for you, because you can create a â€˜self signedâ€™ certificate.  IIS can do this out of the box for localhost - for more Information, see Scott Guthrieâ€™s walkthrough on <a href="https://weblogs.asp.net/scottgu/tip-trick-enabling-ssl-on-iis7-using-self-signed-certificates" target="_blank" rel="noopener">creating a self signed certificate in IIS</a>.</p>
<p>That worked great, for a while.  But with Chrome 58, which was released in May 2017, a new security feature was introduced which prevents Chrome from trusting a self-signed certificate generated by IIS.  The problem is that IIS generates a self signed SSL certificate that doesnâ€™t include a <a href="https://en.wikipedia.org/wiki/Subject_Alternative_Name" target="_blank" rel="noopener">SubjectAlternativeName</a> (SAN), and starting with Chrome 58, <a href="https://developers.google.com/web/updates/2017/03/chrome-58-deprecations#remove_support_for_commonname_matching_in_certificates" target="_blank" rel="noopener">certificates without a SAN are seen as insecure</a>.  </p>
        
          <p class="article-more-link">
            <a href="/2017/09/07/Chrome-58-and-Self-Signed-Certificates-in-IIS/">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codethug.com/2017/09/07/Chrome-58-and-Self-Signed-Certificates-in-IIS/" data-id="ckmson8em000d3gagn7xgedwm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Entity-Framework-Cache-Busting" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/19/Entity-Framework-Cache-Busting/">Entity Framework Cache Busting</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/2016/02/19/Entity-Framework-Cache-Busting/">
    <time datetime="2016-02-19T20:08:05.000Z" itemprop="datePublished">2016-02-19</time>
  </a>
</div>
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The <a href="https://msdn.microsoft.com/en-us/data/jj729737.aspx" target="_blank" rel="noopener">DbContext</a> in Entity Framework 6 automatically caches data that it retrieves from your database.  This is useful, but sometimes data changes outside your context (perhaps by another user) and you end up with stale data.  How can you force Entity Framework to reload the updated data from the database, and when should you do this?</p>
<p>There are several ways to manage this, depending on which version of Entity Framework you are using and what type of application you are writing.</p>
<ol>
<li>Disable Tracking using <code>AsNoTracking()</code></li>
<li>Throw away the <code>DbContext</code> and create a new one</li>
<li>Use an <code>ObjectQuery</code> instead of a <code>DBQuery</code> and set <code>MergeOptions</code></li>
<li>Refresh the Entities</li>
<li>Detatch the Entities</li>
<li>Call GetDatabaseValues to get the updated values for a single Entity</li>
<li>Use the stale data</li>
</ol>
<p>Code related to this post can be found at <a href="https://github.com/codethug/EFCaching" target="_blank" rel="noopener">https://github.com/codethug/EFCaching</a></p>
        
          <p class="article-more-link">
            <a href="/2016/02/19/Entity-Framework-Cache-Busting/">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codethug.com/2016/02/19/Entity-Framework-Cache-Busting/" data-id="ckmson8ev000p3gaghzi902iq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-mocking-dbset" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/20/mocking-dbset/">A Simple interface for fluently mocking a DbSet</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/2015/03/20/mocking-dbset/">
    <time datetime="2015-03-20T13:45:46.000Z" itemprop="datePublished">2015-03-20</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Net/">.Net</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Net/Testing/">Testing</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>You are testing, right?  Have you ever used a mock in your test?  When testing a class, a mock allows you to create an object that looks just like an object that your class depends on, but acts in a very specific way that you specify for your test, so that you can test your class completely isolated from the rest of your code.  If youâ€™re not familiar with mocks, visit <a href="https://github.com/Moq/moq4/wiki/Quickstart" target="_blank" rel="noopener">Moqâ€™s quickstart guide</a> to get started.</p>
<p>Now that you know about mocks, letâ€™s look at mocking something a little more complicated.  If youâ€™ve ever wanted to unit test a method that uses a <code>DbSet&lt;T&gt;</code> to retrieve data, it can be challenging to figure out how to properly mock the <code>DbSet&lt;T&gt;</code>.</p>
        
          <p class="article-more-link">
            <a href="/2015/03/20/mocking-dbset/">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codethug.com/2015/03/20/mocking-dbset/" data-id="ckmson8fo001w3gagyka3h33t" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-web-api-deep-dive-ef-rollbacks" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/20/web-api-deep-dive-ef-rollbacks/">Web API Deep Dive - Testing with EF Rollbacks across HTTP (part 6 of 6)</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/2015/02/20/web-api-deep-dive-ef-rollbacks/">
    <time datetime="2015-02-20T14:30:34.000Z" itemprop="datePublished">2015-02-20</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Net/">.Net</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Net/Web-API/">Web API</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Microsoftâ€™s ASP.Net Web API 2.2 allows you to easily create REST style APIs on an IIS website.  Microsoft has some <a href="http://www.asp.net/web-api" target="_blank" rel="noopener">great documentation</a> on how to get started with it, so I wonâ€™t rehash that here.  Instead, Iâ€™m going to go a little deeper into some powerful features that can be used with Web API.</p>
<ul>
<li>Part 1 - <a href="/2015/01/16/web-api-deep-dive-customizing-auto-generated-documentation-part-1-of-6">Customizing auto-generated documentation</a></li>
<li>Part 2 - <a href="/2015/01/23/web-api-http-response-codes">HTTP Response Codes</a></li>
<li>Part 3 - <a href="/2015/01/30/web-api-exception-handling/">HTTP Error Codes from Exceptions</a></li>
<li>Part 4 - <a href="/2015/02/06/web-api-deep-dive-odata-url-query-options-part-4-of-6/">OData URL Query Options</a></li>
<li>Part 5 - <a href="/2015/02/13/web-api-deep-dive-dto-transformations-and-automapper-part-5-of-6/">DTO Transformations and Automapper</a></li>
<li>Part 6 - Testing with EF Rollbacks across HTTP (this article)</li>
</ul>
<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>A few weeks ago I wrote an article called <a href="/2014/08/15/cleaning-up-ef-6-tests-with-transaction-rollbacks/">Cleaning Up EF 6 Tests With Transactions Rollbacks</a>, where I showed how to create integration tests that set up some data in a database, run a test against the data, and then roll back all changes to the data.  The rollback was possible because all of the changes to the data were wrapped up inside a transaction.</p>
<p>This posts extends that idea, but instead of a test calling methods on a repository or service layer, this test makes an HTTP call against a Web API endpoint, while preserving the ability to revert all changes to the database as part of a transaction rollback.</p>
<p>The interesting part here is that we will create a database context, start a transaction against that context, create some test data, and then spin up a Web API server that uses that same context.  When weâ€™re done with our tests, weâ€™ll roll back the transaction so that the database changes are all reverted.</p>
<p><strong>2016-01-27 Update - clarified when Configuration is available in an API Controller</strong></p>
        
          <p class="article-more-link">
            <a href="/2015/02/20/web-api-deep-dive-ef-rollbacks/">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codethug.com/2015/02/20/web-api-deep-dive-ef-rollbacks/" data-id="ckmson8h7003q3gagqs5ob7sb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>



  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">recent posts</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"></p> -->
              <p class="item-title"><a href="/2021/03/17/Caching-with-Attributes-in-DotNet-Core5/" class="title">Caching with Attributes in .Net Core 5</a></p>
              <p class="item-date"><time datetime="2021-03-17T18:22:57.000Z" itemprop="datePublished">2021-03-17</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"></p> -->
              <p class="item-title"><a href="/2017/09/09/Mocking-Extension-Methods/" class="title">Mocking Extension Methods</a></p>
              <p class="item-date"><time datetime="2017-09-09T16:21:30.000Z" itemprop="datePublished">2017-09-09</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"></p> -->
              <p class="item-title"><a href="/2017/09/07/Chrome-58-and-Self-Signed-Certificates-in-IIS/" class="title">Chrome 58 and Self Signed Certificates in IIS</a></p>
              <p class="item-date"><time datetime="2017-09-07T16:09:02.000Z" itemprop="datePublished">2017-09-07</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"></p> -->
              <p class="item-title"><a href="/2016/02/19/Entity-Framework-Cache-Busting/" class="title">Entity Framework Cache Busting</a></p>
              <p class="item-date"><time datetime="2016-02-19T20:08:05.000Z" itemprop="datePublished">2016-02-19</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"><a class="article-category-link" href="/categories/Net/">.Net</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Net/Testing/">Testing</a></p> -->
              <p class="item-title"><a href="/2015/03/20/mocking-dbset/" class="title">A Simple interface for fluently mocking a DbSet</a></p>
              <p class="item-date"><time datetime="2015-03-20T13:45:46.000Z" itemprop="datePublished">2015-03-20</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">September 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">April 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/01/">January 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/11/">November 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/07/">July 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/06/">June 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">May 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/11/">November 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/10/">October 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/07/">July 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">June 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/05/">May 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03/">March 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/10/">October 2009</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/03/">March 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/12/">December 2008</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Tim Larson<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>