<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Caching with Attributes in .Net Core 5 | Codethug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="You had a performance problem, and you solved it by implementing caching: 1var people = PersonRepository.GetByLastName(personId); 1234567891011121314151617181920212223242526public class PersonReposito">
<meta property="og:type" content="article">
<meta property="og:title" content="Caching with Attributes in .Net Core 5">
<meta property="og:url" content="http://codethug.com/2021/03/17/Caching-with-Attributes-in-DotNet-Core5/index.html">
<meta property="og:site_name" content="Codethug">
<meta property="og:description" content="You had a performance problem, and you solved it by implementing caching: 1var people = PersonRepository.GetByLastName(personId); 1234567891011121314151617181920212223242526public class PersonReposito">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2021-03-17T18:55:59.617Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Caching with Attributes in .Net Core 5">
<meta name="twitter:description" content="You had a performance problem, and you solved it by implementing caching: 1var people = PersonRepository.GetByLastName(personId); 1234567891011121314151617181920212223242526public class PersonReposito">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Open+Sans:400italic,400,600" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-61949305-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-61949305-1');
</script>
<!-- End Google Analytics -->


</head>
</html>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo">
        <!-- <i class="logo"></i> -->
        <span class="site-title">Codethug</span>
      </a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <div class="profile" id="profile-nav">
          <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://s.gravatar.com/avatar/e18193ec07249288118577b3b51c8834?s=128"><i class="fa fa-caret-down"></i></a>
        </div>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://codethug.com"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
        <td><a class="main-nav-link" href="/">Home</a></td>
      
        <td><a class="main-nav-link" href="/archives">Archives</a></td>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://codethug.com"></form>
      </td>
      </tr>
    </table>
  </div>
  
</header>

    <div class="outer">
      <aside id="profile">
  <div class="inner profile-inner">
  	<div class="base-info profile-block">
		  <img id="avatar" src="https://s.gravatar.com/avatar/e18193ec07249288118577b3b51c8834?s=128">
      <h2 id="name">Tim Larson</h2>
      <h3 id="title">Codethug</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Salt Lake City, UT</span>
      <!-- <a id="follow" href="null">FOLLOW</a> -->
  	</div>
    <!--<div class="article-info profile-block">
      <div class="article-info-block">
        59
        <span>posts</span>
      </div>
      <div class="article-info-block">
        0
        <span>tag</span>
      </div>
    </div>-->
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
        
          <td><a href="http://github.com/codethug" title="github"><i class="fa fa-github"></i></a></td>
        
          <td><a href="http://twitter.com/codethug" title="twitter"><i class="fa fa-twitter"></i></a></td>
        
          <td><a href="http://linkedin.com/in/larsontim" title="linkedin"><i class="fa fa-linkedin"></i></a></td>
        
          <td><a href="http://stackoverflow.com/users/133852/codethug" title="stack-overflow"><i class="fa fa-stack-overflow"></i></a></td>
        
          <td><a href="http://feeds.feedburner.com/CodeThug" title="rss"><i class="fa fa-rss"></i></a></td>
        
        </tr>
      </table>
    </div>
  </div>
</aside>

      <section id="main"><article id="post-Caching-with-Attributes-in-DotNet-Core5" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Caching with Attributes in .Net Core 5
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/2021/03/17/Caching-with-Attributes-in-DotNet-Core5/">
    <time datetime="2021-03-17T18:22:57.000Z" itemprop="datePublished">2021-03-17</time>
  </a>
</div>
          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>You had a performance problem, and you solved it by implementing caching:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> people = PersonRepository.GetByLastName(personId);</span><br></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PersonRepository</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> secondsToCacheResult = <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;Person&gt;&gt; GetByLastName(<span class="keyword">string</span> lastName)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> cacheKey = buildCacheKey(lastName);</span><br><span class="line">        <span class="keyword">if</span> (_cache.ContainsKey(cacheKey)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> _cache[cacheKey] <span class="keyword">as</span> Person;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This part takes a long time, that's why we </span></span><br><span class="line">        <span class="comment">// want to cache the results</span></span><br><span class="line">        <span class="keyword">var</span> people = SomeLongRunningProcess(lastName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> options = <span class="keyword">new</span> MemoryCacheEntryOptions</span><br><span class="line">        &#123;</span><br><span class="line">            AbsoluteExpirationRelativeToNow = <span class="keyword">new</span> System.TimeSpan(</span><br><span class="line">                hours: <span class="number">0</span>, minutes: <span class="number">0</span>, seconds: secondsToCacheResult)</span><br><span class="line">        &#125;;</span><br><span class="line">        _cache.Add(cacheKey, people, options)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> people;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And it worked!  The performance problem is solved.  But then you start caching things in several places in your repositories, and you end up with this exact same caching code everywhere.  Not only are you violating the <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" target="_blank" rel="noopener">DRY principle</a>, but it makes it much harder to understand whatâ€™s really going on in the repository method.</p>
<p>This new problem can be solved by using Aspect Oriented Programming in a Dependency Injection framework by using interception with attributes to make your code look like this instead:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Cache(Seconds = 30)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;Person&gt;&gt; GetPeopleByLastName(<span class="keyword">string</span> lastName)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> SomeLongRunningProcess(lastName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We could use DI to <a href="https://www.palmmedia.de/Blog/2010/9/26/aop-interception-with-unity-20" target="_blank" rel="noopener">solve this with Microsoftâ€™s Unity DI</a>, or <a href="https://medium.com/@mohsen_rajabi/asp-core-automating-cache-with-aspect-programing-autofac-dynamic-proxy-8e6b84df44e4" target="_blank" rel="noopener">with AutoFac</a>.  Or we could <a href="https://doc.postsharp.net/caching-getting-started" target="_blank" rel="noopener">use PostSharp</a>, which â€˜weavesâ€™ the IL of your code with the code for caching at compile time.  But I wanted to get this working with Microsoftâ€™s DI framework that comes with .Net Core 5.</p>
<p>But thereâ€™s a problem - Microsoftâ€™s DI doesnâ€™t natively support interceptors, so we have to bring in some extra help.  In this case, weâ€™re going to use the Castle Projectâ€™s DynamicProxy library.  </p>
<a id="more"></a>
<p>In order to be able to add the attribute as seen above and have the caching magically happen, we need to setup 4 things:</p>
<ol>
<li><code>CacheAttribute</code> - This defines which method should have its results cached and how the results should be cached.</li>
<li><code>CacheInterceptor</code> - This is like pipeline middleware, but for calling a method.  This gets injected between the method and the code calling the method, and it decides whether to return a value found in the cache, or whether to let the method run and generate the return value (which is then added to the cache).</li>
<li><code>ServiceExtensions</code> - An extension method to help us register the class in our DI container so that the CacheInterceptor is used.</li>
<li><code>Startup.cs</code> - We have to add a few lines to wire everything up</li>
</ol>
<h3 id="CacheAttribute"><a href="#CacheAttribute" class="headerlink" title="CacheAttribute"></a>CacheAttribute</h3><p>First, add an attribute class.  This attribute is used to identify methods that we want to cache.  Customize this to add whatever cache settings might be useful in your scenario, such as if you want to use a sliding window, etc.  Iâ€™m keeping this simple, so all we have is a timeout with a default value of 30 seconds.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCore5.Common.Interception</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">AttributeUsage(AttributeTargets.Method, AllowMultiple = false)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CacheAttribute</span> : <span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Seconds &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CacheInterceptor"><a href="#CacheInterceptor" class="headerlink" title="CacheInterceptor"></a>CacheInterceptor</h3><p>Second, we add the interceptor.  This is similar to middleware, because it lets us add logic between a method and a line of code that calls that method.  Iâ€™m using MemoryCache, which is automatically set up and injected by Microsoftâ€™s DI, but you can use whatever other mechanism you need for caching the results.</p>
<p>This requires the <a href="https://www.nuget.org/packages/Castle.Core/" target="_blank" rel="noopener">Castle.Core Nuget package</a>.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Castle.DynamicProxy;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Caching.Memory;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DotNetCore5.Common.Interception</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CacheInterceptor</span> : <span class="title">IInterceptor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> IMemoryCache _memoryCache;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CacheInterceptor</span>(<span class="params">IMemoryCache memoryCache</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            _memoryCache = memoryCache;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a cache key using the name of the method and the values</span></span><br><span class="line">        <span class="comment">// of its arguments so that if the same method is called with the</span></span><br><span class="line">        <span class="comment">// same arguments in the future, we can find out if the results </span></span><br><span class="line">        <span class="comment">// are cached or not</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">GenerateCacheKey</span>(<span class="params"><span class="keyword">string</span> name, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">object</span>[] arguments</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (arguments == <span class="literal">null</span> || arguments.Length == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> name;</span><br><span class="line">            <span class="keyword">return</span> name + <span class="string">"--"</span> + </span><br><span class="line">                <span class="keyword">string</span>.Join(<span class="string">"--"</span>, arguments.Select(a =&gt; </span><br><span class="line">                    a == <span class="literal">null</span> ? <span class="string">"**NULL**"</span> : a.ToString()).ToArray());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Intercept</span>(<span class="params">IInvocation invocation</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> cacheAttribute = invocation.MethodInvocationTarget</span><br><span class="line">                .GetCustomAttributes(<span class="keyword">typeof</span>(CacheAttribute), <span class="literal">false</span>)</span><br><span class="line">                .FirstOrDefault() <span class="keyword">as</span> CacheAttribute;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the cache attribute is added ot this method, we </span></span><br><span class="line">            <span class="comment">// need to intercept this call</span></span><br><span class="line">            <span class="keyword">if</span> (cacheAttribute != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> cacheKey = GenerateCacheKey(invocation.Method.Name, </span><br><span class="line">                    invocation.Arguments);</span><br><span class="line">                <span class="keyword">if</span> (_memoryCache.TryGetValue(cacheKey, <span class="keyword">out</span> <span class="keyword">object</span> <span class="keyword">value</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// The results were already in the cache so return </span></span><br><span class="line">                    <span class="comment">// them from the cache instead of calling the </span></span><br><span class="line">                    <span class="comment">// underlying method</span></span><br><span class="line">                    invocation.ReturnValue = <span class="keyword">value</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// Get the result the hard way by calling </span></span><br><span class="line">                    <span class="comment">// the underlying method</span></span><br><span class="line">                    invocation.Proceed();</span><br><span class="line">                    <span class="comment">// Save the result in the cache</span></span><br><span class="line">                    <span class="keyword">var</span> options = <span class="keyword">new</span> MemoryCacheEntryOptions</span><br><span class="line">                    &#123;</span><br><span class="line">                        AbsoluteExpirationRelativeToNow = </span><br><span class="line">                            <span class="keyword">new</span> System.TimeSpan(hours: <span class="number">0</span>, minutes: <span class="number">0</span>, </span><br><span class="line">                                seconds: cacheAttribute.Seconds)</span><br><span class="line">                    &#125;;</span><br><span class="line">                    _memoryCache.Set(cacheKey, invocation.ReturnValue, </span><br><span class="line">                        options);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// We don't need to cache the results, </span></span><br><span class="line">                <span class="comment">// nothing to see here</span></span><br><span class="line">                invocation.Proceed();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Service-Extensions"><a href="#Service-Extensions" class="headerlink" title="Service Extensions"></a>Service Extensions</h3><p>Third, weâ€™ll add an extension method to make it easier to use the CacheInterceptor when registering services.  You may need to add other similar extension methods depending on how you like to use DI.</p>
<p>Please note that in order for this entire idea to work, the class that has methods to cache must implement an interface, that that interface is what gets injected into the other class that uses it.  That is, if you want to cache the results of a method on <code>MyRepository</code>, then <code>MyRepository</code> must implement <code>IMyRepository</code> and <code>IMyRepository</code> must be injected into <code>MyController</code>.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ServicesExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> AddProxiedScoped&lt;TInterface, TImplementation&gt;</span><br><span class="line">        (<span class="keyword">this</span> IServiceCollection services)</span><br><span class="line">        <span class="keyword">where</span> TInterface : <span class="keyword">class</span></span><br><span class="line">        <span class="title">where</span> <span class="title">TImplementation</span> : <span class="title">class</span>, <span class="title">TInterface</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// This registers the underlying class</span></span><br><span class="line">        services.AddScoped&lt;TImplementation&gt;();</span><br><span class="line">        services.AddScoped(<span class="keyword">typeof</span>(TInterface), serviceProvider =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Get an instance of the Castle Proxy Generator</span></span><br><span class="line">            <span class="keyword">var</span> proxyGenerator = serviceProvider</span><br><span class="line">                .GetRequiredService&lt;ProxyGenerator&gt;();</span><br><span class="line">            <span class="comment">// Have DI build out an instance of the class that has methods</span></span><br><span class="line">            <span class="comment">// you want to cache (this is a normal instance of that class </span></span><br><span class="line">            <span class="comment">// without caching added)</span></span><br><span class="line">            <span class="keyword">var</span> actual = serviceProvider</span><br><span class="line">                .GetRequiredService&lt;TImplementation&gt;();</span><br><span class="line">            <span class="comment">// Find all of the interceptors that have been registered, </span></span><br><span class="line">            <span class="comment">// including our caching interceptor.  (you might later add a </span></span><br><span class="line">            <span class="comment">// logging interceptor, etc.)</span></span><br><span class="line">            <span class="keyword">var</span> interceptors = serviceProvider</span><br><span class="line">                .GetServices&lt;IInterceptor&gt;().ToArray();</span><br><span class="line">            <span class="comment">// Have Castle Proxy build out a proxy object that implements </span></span><br><span class="line">            <span class="comment">// your interface, but adds a caching layer on top of the</span></span><br><span class="line">            <span class="comment">// actual implementation of the class.  This proxy object is</span></span><br><span class="line">            <span class="comment">// what will then get injected into the class that has a </span></span><br><span class="line">            <span class="comment">// dependency on TInterface</span></span><br><span class="line">            <span class="keyword">return</span> proxyGenerator.CreateInterfaceProxyWithTarget(</span><br><span class="line">                <span class="keyword">typeof</span>(TInterface), actual, interceptors);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Startup-cs"><a href="#Startup-cs" class="headerlink" title="Startup.cs"></a>Startup.cs</h3><p>Fourth, we add a few lines to <code>Startup.cs</code>.</p>
<p>In <code>Startup.cs</code>, ConfigureServices needs to be changed.  Add two lines for setting up interception.  These two lines register the <code>ProxyGenerator</code> and the <code>CacheInterceptor</code>.  For any classes that need caching added, in addition to adding the <code>CacheAttribute</code> on one of its methods, we register it here with <code>services.AddProxiedScoped&lt;TInterface, T&gt;()</code> instead of  <code>services.AddScoped&lt;TInterface, T&gt;()</code>.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Setup Interception</span></span><br><span class="line">    services.AddSingleton(<span class="keyword">new</span> ProxyGenerator());</span><br><span class="line">    services.AddScoped&lt;IInterceptor, CacheInterceptor&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register with the AddProxiedScope method.  When a class needs an </span></span><br><span class="line">    <span class="comment">// IPersonRepository injected, then DynamicProxy will create a proxy</span></span><br><span class="line">    <span class="comment">// object by adding a caching layer on top of the real </span></span><br><span class="line">    <span class="comment">// PersonRepository.  That proxy object will be injected into </span></span><br><span class="line">    <span class="comment">// the class that needs an IPersonRepository injected into it.</span></span><br><span class="line">    services.AddProxiedScoped&lt;IPersonRepository, PersonRepository&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Other registrations</span></span><br><span class="line">    services.AddScoped&lt;SomeOtherClassThatDoesntNeedCaching&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This was already in this method because we're doing MVC</span></span><br><span class="line">    services.AddControllersWithViews();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><p>Thatâ€™s all of the setup.  When you need to add caching to a method, it will require two steps:</p>
<ol>
<li><p>Change the DI registration for the class that has a method that needs to be cached.  This can be done in <code>Startup.ConfigureServices</code> by changing that classâ€™ registration from <code>services.AddScoped</code> to <code>services.AddProxiedScoped</code>.</p>
</li>
<li><p>Add the Cache attribute to the method, like this:</p>
</li>
</ol>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Cache(Seconds = 30)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IEnumerable&lt;Person&gt;&gt; GetPeopleByLastName(<span class="keyword">string</span> lastName)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> SomeLongRunningProcess(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Thanks to <a href="https://www.linkedin.com/in/zanid-haytam/" target="_blank" rel="noopener">Zanid Haytam</a> for his post on <a href="https://blog.zhaytam.com/2020/08/18/aspnetcore-dynamic-proxies-for-aop/" target="_blank" rel="noopener">AOP using Proxies</a>.  I couldnâ€™t have figured this out this without his blog post.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://codethug.com/2021/03/17/Caching-with-Attributes-in-DotNet-Core5/" data-id="ckmson8eu000m3gagfmhtjv57" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/09/09/Mocking-Extension-Methods/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Mocking Extension Methods</div>
    </a>
  
</nav>

  
</article>


</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">recent posts</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"></p> -->
              <p class="item-title"><a href="/2021/03/17/Caching-with-Attributes-in-DotNet-Core5/" class="title">Caching with Attributes in .Net Core 5</a></p>
              <p class="item-date"><time datetime="2021-03-17T18:22:57.000Z" itemprop="datePublished">2021-03-17</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"></p> -->
              <p class="item-title"><a href="/2017/09/09/Mocking-Extension-Methods/" class="title">Mocking Extension Methods</a></p>
              <p class="item-date"><time datetime="2017-09-09T16:21:30.000Z" itemprop="datePublished">2017-09-09</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"></p> -->
              <p class="item-title"><a href="/2017/09/07/Chrome-58-and-Self-Signed-Certificates-in-IIS/" class="title">Chrome 58 and Self Signed Certificates in IIS</a></p>
              <p class="item-date"><time datetime="2017-09-07T16:09:02.000Z" itemprop="datePublished">2017-09-07</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"></p> -->
              <p class="item-title"><a href="/2016/02/19/Entity-Framework-Cache-Busting/" class="title">Entity Framework Cache Busting</a></p>
              <p class="item-date"><time datetime="2016-02-19T20:08:05.000Z" itemprop="datePublished">2016-02-19</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <!-- <p class="item-category"><a class="article-category-link" href="/categories/Net/">.Net</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/categories/Net/Testing/">Testing</a></p> -->
              <p class="item-title"><a href="/2015/03/20/mocking-dbset/" class="title">A Simple interface for fluently mocking a DbSet</a></p>
              <p class="item-date"><time datetime="2015-03-20T13:45:46.000Z" itemprop="datePublished">2015-03-20</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">September 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/04/">April 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/01/">January 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/11/">November 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/07/">July 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/06/">June 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">May 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/11/">November 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/10/">October 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/07/">July 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">June 2010</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/05/">May 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/03/">March 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/10/">October 2009</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/03/">March 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/12/">December 2008</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Tim Larson<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>